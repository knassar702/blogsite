<!doctype html><html><head><title>How I Solved the intigriti CURL challenge - Khaled Nassar</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Khaled Nassar"><link rel="shortcut icon" type=image/x-icon href=https://blog.knas.me/img/favicon.ico><link rel=stylesheet href=https://blog.knas.me/style.min.39acacc5d2051426f655a6b7fbf4786fbd0fd8fffd09322c9b497ef0f7439b3f.css integrity="sha256-OaysxdIFFCb2Vaa3+/R4b70P2P/9CTIsm0l+8PdDmz8="><link rel=stylesheet href=https://blog.knas.me/style-dark.min.0a647fb6c07e04b77b54fa0515d0a683d39ecdb251dba960fe1f966f7ff36fc2.css media="(prefers-color-scheme: dark)" integrity="sha256-CmR/tsB+BLd7VPoFFdCmg9OezbJR26lg/h+Wb3/zb8I="><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.1/css/all.css><meta property="og:title" content="How I Solved the intigriti CURL challenge"><meta property="og:description" content="I woke up this morning to something interesting from Initgrit on Twitter. That&rsquo;s a good challenge for reading files from servers
My fast break is over, so I turn on my computer and start looking at the code they provided
https://twitter.com/intigriti/status/1623663004532281348
Source Code Review Basically, it accepts POST method with url and image parameters for &lsquo;update picture&rsquo;.
There are two validations here, one for the host, so the developer makes sure it&rsquo;s localhost, and another for the image, so the extension makes sure it&rsquo;s a real image"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.knas.me/blog/initgriti_curl/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-02-09T18:32:20+02:00"><meta property="article:modified_time" content="2023-02-09T18:32:20+02:00"><meta itemprop=name content="How I Solved the intigriti CURL challenge"><meta itemprop=description content="I woke up this morning to something interesting from Initgrit on Twitter. That&rsquo;s a good challenge for reading files from servers
My fast break is over, so I turn on my computer and start looking at the code they provided
https://twitter.com/intigriti/status/1623663004532281348
Source Code Review Basically, it accepts POST method with url and image parameters for &lsquo;update picture&rsquo;.
There are two validations here, one for the host, so the developer makes sure it&rsquo;s localhost, and another for the image, so the extension makes sure it&rsquo;s a real image"><meta itemprop=datePublished content="2023-02-09T18:32:20+02:00"><meta itemprop=dateModified content="2023-02-09T18:32:20+02:00"><meta itemprop=wordCount content="728"><meta itemprop=keywords content="bugbounty,security,webpentesting,"><meta name=twitter:card content="summary"><meta name=twitter:image content="https://blog.knas.me/img/avatar.jpg"><meta name=twitter:title content="How I Solved the intigriti CURL challenge"><meta name=twitter:description content="I woke up this morning to something interesting from Initgrit on Twitter. That&rsquo;s a good challenge for reading files from servers
My fast break is over, so I turn on my computer and start looking at the code they provided
https://twitter.com/intigriti/status/1623663004532281348
Source Code Review Basically, it accepts POST method with url and image parameters for &lsquo;update picture&rsquo;.
There are two validations here, one for the host, so the developer makes sure it&rsquo;s localhost, and another for the image, so the extension makes sure it&rsquo;s a real image"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><h1>How I Solved the intigriti CURL challenge</h1><header><div class=avatar><img class=avatarMask src=https://blog.knas.me/img/avatar.jpg alt>
<a href=https://blog.knas.me><img class=avatar-border src=https://blog.knas.me/img/avatar-border.svg alt></a></div><h2><a class=author href=https://blog.knas.me>Khaled Nassar</a></h2></header><p class=date>February 9, 2023</p><div id=tags><ul><li><a href=https://blog.knas.me/tags/bugbounty/>bugbounty</a></li><li><a href=https://blog.knas.me/tags/security/>security</a></li><li><a href=https://blog.knas.me/tags/webpentesting/>webpentesting</a></li></ul></div><div id=contentBody><p>I woke up this morning to something interesting from Initgrit on Twitter. That&rsquo;s a good challenge for reading files from servers</p><p>My fast break is over, so I turn on my computer and start looking at the code they provided</p><p><img src=https://blog.knas.me/images/init_twitter.png alt=init_twitter>
<a href=https://twitter.com/intigriti/status/1623663004532281348>https://twitter.com/intigriti/status/1623663004532281348</a></p><h2 id=source-code-review>Source Code Review</h2><p>Basically, it accepts POST method with url and image parameters for &lsquo;update picture&rsquo;.</p><p>There are two validations here, one for the host, so the developer makes sure it&rsquo;s localhost, and another for the image, so the extension makes sure it&rsquo;s a real image</p><p>If all validations are fine, the backend will send an HTTP request with the value of the url parameter and the image name to upload the image</p><p>Also the Curl is executing by subprocess.run with Shell=True flag, which means it&rsquo;s use shell</p><p>We&rsquo;re good, I thought I could inject some payloads with quotes and get RCE, and say yayyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy</p><p>As fast as I figured out that the developer was using shelx.qoute to store all values between single quotes:(</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> shlex <span style=color:#f92672>import</span> quote
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ls -l </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(quote(filename))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(command)
</span></span><span style=display:flex><span>ls <span style=color:#f92672>-</span>l <span style=color:#e6db74>&#39;somefile; rm -rf ~&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> remote_command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ssh home </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(quote(command))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(remote_command)
</span></span><span style=display:flex><span>ssh home <span style=color:#e6db74>&#39;ls -l &#39;</span><span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#e6db74>&#39;somefile; rm -rf ~&#39;</span><span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#e6db74>&#39;&#39;</span>
</span></span></code></pre></div><h2 id=trying-to-bypass>Trying to bypass</h2><p>Ok, I accepted the challenge, and I didn&rsquo;t want to start doing random stuff like fuzzing or anything like that
Let me do a little research about <code>shelx.quote</code> and see if there are any new CVEs or warnings about it
According to the official module documentation, there&rsquo;s a warning
<img src=https://blog.knas.me/images/py_warn.png alt=py_warn></p><blockquote><p><a href=http://en.wikipedia.org/wiki/POSIX>POSIX</a> is a family of standards, specified by the <a href=http://www.ieee.org/portal/site>IEEE</a>, to clarify and make uniform the application programming interfaces (and ancillary issues, such as command line shell utilities) provided by Unix operating systems.</p></blockquote><p>Then I&rsquo;ll have to try bypassing this on a non-POSIX shell or on Windows
There are two options here, one for Windows and one for testing it on Linux
There&rsquo;s only one problem: Linux is POSIX, and bash is also POSIX.</p><blockquote><p>Good damn I hate computers</p></blockquote><p>Anyhow, I looked for NON-POSIX shells for Linux and I found the &lsquo;fish&rsquo; shell, it&rsquo;s awesome and non-posix, so let&rsquo;s try it out</p><p>After I fuzzed the parameter with singlequates bypassing all my techniques and spent an hour on it, it didn&rsquo;t work that much.
<a href=https://github.com/commixproject/commix/blob/master/src/core/tamper/singlequotes.py>https://github.com/commixproject/commix/blob/master/src/core/tamper/singlequotes.py</a></p><p>And after I saw that the file was in /home/[USER]/hello.png, I twitted about it to make sure it&rsquo;s the right one
<img src=https://blog.knas.me/images/init_twitter2.png alt=init_twitter2></p><h3 id=playing-with-curl>Playing with CURL</h3><p>I took a look at curl after seeing this tweet and I noticed something
Using the @ sign at the start of a file name can be readed by CURL
As you remember, the developer makes sure the filename is PNG
so PNG is good for me if this server was my friend server that sharing a good memes in the Slack #random channel but here the case is diffrent I want to read real stuff like /etc/passwd</p><p>hmmmm what to do now ?
As I started looking at the official documentation of CURL command, I found that with the -F option, I can upload the file name while reading another file, so I can upload a different file and then read a different file
The file would be upload as meme.png, content would be /etc/passwd/ file
This isn&rsquo;t magic, but you can change the file parameters like the content, type, name, etc&mldr;</p><p>occurding to this page documetion page <a href=https://curl.se/docs/manpage.html#-F>https://curl.se/docs/manpage.html#-F</a></p><blockquote><p>You can add custom headers to the field by setting headers=, like</p></blockquote><pre tabindex=0><code>$Â curl -F &#34;submit=OK;headers=@headerfile&#34; example.com
</code></pre><p>that&rsquo;s intersting let&rsquo;s try this trick</p><h4 id=solving-the-chanlleng>Solving the Chanlleng</h4><p>To get started, we need to bypass the url localhost check first. I did that with the burpsuite callback and added localhost at the beginning of the host like that: <a href=http://localhost.OAST_HOST.com>http://localhost.OAST_HOST.com</a>
And let&rsquo;s use headers parameter to bypass the image extensions</p><p>Then we&rsquo;ll add a png file to the parameter value after adding the file we want to read in headers</p><p>and here we go
<img src=https://blog.knas.me/images/req_1.png alt=req_1>
the response was <code>200</code> but by looking at the OAST log you can see we got the file content finally
<img src=https://blog.knas.me/images/req_2.png alt=req_2></p><p>YAYYYY</p><p>So I send tweet about it and they said I&rsquo;m right
<img src=https://blog.knas.me/images/init_twitter3.png alt=init_twitter3></p><p>And I receved their message like this</p><p><img src=https://media.tenor.com/HhkGoOsFrHkAAAAd/jgksjmn-girl.gif alt=GIF></p><h4 id=what-i-learned-from-that>What I learned from that?</h4><p>a few things</p><ul><li>Think before doing anything</li><li>READ AND READ The offical documentation you will learn a lot</li></ul><p>and yeah that&rsquo;s it for today I hope you find this useful</p><p>bye ..</p></div><footer><p>&copy; 2019 Khaled Nassar.
Powered by <a href=https://gohugo.io/>Hugo</a>
using the <a href=https://github.com/koirand/pulp/>pulp</a> theme.</p></footer></body></html>